<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - MedSync NP Router</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['IBM Plex Sans', 'sans-serif'],
          },
          colors: {
            brand: {
              purple: '#7030a0',
              blue: '#3656b8',
              cyan: '#01a7cb',
            }
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <!-- Toast Container -->
  <div id="toast-container"></div>

  <!-- Navigation -->
  <nav class="bg-white border-b border-gray-200 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center gap-2">
          <img src="./medsync-logo.png" alt="MedSync" class="h-8 w-auto">
          <span class="text-xl font-bold text-gray-900">NP Router</span>
        </div>
        <div class="flex items-center gap-6">
          <a href="index.html" class="text-gray-600 hover:text-gray-900">Finder</a>
          <a href="roster.html" class="text-gray-600 hover:text-gray-900">Roster</a>
          <a href="dashboard.html" class="text-brand-blue font-medium border-b-2 border-brand-blue pb-1">Dashboard</a>
        </div>
        <div class="flex items-center gap-4">
          <span id="userEmail" class="text-sm text-gray-600"></span>
          <button id="logoutBtn" class="text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1">
            <i data-feather="log-out" class="h-4 w-4"></i>
            Sign Out
          </button>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-green-100 rounded-lg">
            <i data-feather="users" class="h-5 w-5 text-green-600"></i>
          </div>
          <div>
            <div class="text-sm text-gray-500">Active Providers</div>
            <div class="text-2xl font-bold text-gray-900" id="statActiveProviders">0</div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-blue-100 rounded-lg">
            <i data-feather="map" class="h-5 w-5 text-blue-600"></i>
          </div>
          <div>
            <div class="text-sm text-gray-500">States Covered</div>
            <div class="text-2xl font-bold text-gray-900" id="statStatesCovered">0</div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-purple-100 rounded-lg">
            <i data-feather="shield" class="h-5 w-5 text-purple-600"></i>
          </div>
          <div>
            <div class="text-sm text-gray-500">Payers Covered</div>
            <div class="text-2xl font-bold text-gray-900" id="statPayersCovered">0</div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-red-100 rounded-lg">
            <i data-feather="alert-triangle" class="h-5 w-5 text-red-600"></i>
          </div>
          <div>
            <div class="text-sm text-gray-500">Coverage Gaps</div>
            <div class="text-2xl font-bold text-gray-900" id="statGaps">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Coverage Gap Matrix -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Coverage Gap Matrix</h2>
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" id="priorityStatesToggle" class="w-4 h-4 text-brand-blue rounded focus:ring-brand-blue">
          <span class="text-sm text-gray-700">Priority States Only</span>
        </label>
      </div>
      <div class="mb-4 flex flex-wrap gap-4 text-sm">
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-green-100 border border-green-300 rounded"></div>
          <span class="text-gray-600">Routable Now</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-blue-100 border border-blue-300 rounded"></div>
          <span class="text-gray-600">Approved - Pending Effective</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-amber-100 border border-amber-300 rounded"></div>
          <span class="text-gray-600">In Progress</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 bg-red-100 border border-red-300 rounded"></div>
          <span class="text-gray-600">Gap</span>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full" id="coverageMatrix">
          <thead>
            <tr>
              <th class="text-left py-2 px-3 text-sm font-medium text-gray-500 bg-gray-50">State</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Top Unmatched Searches -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Unmatched Searches</h2>
        <p class="text-sm text-gray-500 mb-4">State + Payer combinations with the most failed routing attempts</p>
        <div id="unmatchedSearches" class="space-y-2">
          <div class="text-center py-8 text-gray-500">
            <div class="loading-spinner mx-auto mb-2"></div>
            Loading...
          </div>
        </div>
      </div>

      <!-- Recent Routing Activity -->
      <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Recent Routing Activity</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500 border-b">
                <th class="pb-2 font-medium">Time</th>
                <th class="pb-2 font-medium">State</th>
                <th class="pb-2 font-medium">Payer</th>
                <th class="pb-2 font-medium">Match</th>
                <th class="pb-2 font-medium">By</th>
              </tr>
            </thead>
            <tbody id="routingActivity">
              <tr>
                <td colspan="5" class="text-center py-8 text-gray-500">
                  <div class="loading-spinner mx-auto mb-2"></div>
                  Loading...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { requireAuth, wireLogoutButton, getCurrentUser } from './auth.js';
    import { getSupabase } from './supabaseClient.js';

    // Constants
    const US_STATES = [
      { code: "AL", name: "Alabama" }, { code: "AK", name: "Alaska" },
      { code: "AZ", name: "Arizona" }, { code: "AR", name: "Arkansas" },
      { code: "CA", name: "California" }, { code: "CO", name: "Colorado" },
      { code: "CT", name: "Connecticut" }, { code: "DC", name: "District of Columbia" },
      { code: "DE", name: "Delaware" }, { code: "FL", name: "Florida" },
      { code: "GA", name: "Georgia" }, { code: "HI", name: "Hawaii" },
      { code: "ID", name: "Idaho" }, { code: "IL", name: "Illinois" },
      { code: "IN", name: "Indiana" }, { code: "IA", name: "Iowa" },
      { code: "KS", name: "Kansas" }, { code: "KY", name: "Kentucky" },
      { code: "LA", name: "Louisiana" }, { code: "ME", name: "Maine" },
      { code: "MD", name: "Maryland" }, { code: "MA", name: "Massachusetts" },
      { code: "MI", name: "Michigan" }, { code: "MN", name: "Minnesota" },
      { code: "MS", name: "Mississippi" }, { code: "MO", name: "Missouri" },
      { code: "MT", name: "Montana" }, { code: "NE", name: "Nebraska" },
      { code: "NV", name: "Nevada" }, { code: "NH", name: "New Hampshire" },
      { code: "NJ", name: "New Jersey" }, { code: "NM", name: "New Mexico" },
      { code: "NY", name: "New York" }, { code: "NC", name: "North Carolina" },
      { code: "ND", name: "North Dakota" }, { code: "OH", name: "Ohio" },
      { code: "OK", name: "Oklahoma" }, { code: "OR", name: "Oregon" },
      { code: "PA", name: "Pennsylvania" }, { code: "RI", name: "Rhode Island" },
      { code: "SC", name: "South Carolina" }, { code: "SD", name: "South Dakota" },
      { code: "TN", name: "Tennessee" }, { code: "TX", name: "Texas" },
      { code: "UT", name: "Utah" }, { code: "VT", name: "Vermont" },
      { code: "VA", name: "Virginia" }, { code: "WA", name: "Washington" },
      { code: "WV", name: "West Virginia" }, { code: "WI", name: "Wisconsin" },
      { code: "WY", name: "Wyoming" }
    ];

    const CANONICAL_PAYERS = ["Medicare", "Medicaid", "Aetna", "UHC", "BCBS", "Cigna", "Humana", "TRICARE"];
    const OTHER_PAYERS = ["Claritev/Multiplan", "Ambetter", "Devoted Health", "Oscar", "Optum"];
    const ALL_PAYERS = [...CANONICAL_PAYERS, ...OTHER_PAYERS];
    const PRIORITY_STATES = ["FL", "AZ", "MS", "MI", "NV", "TX", "TN", "PA", "MT", "ID", "WA"];

    let currentUser = null;
    let supabase = null;
    let providers = [];
    let credentials = [];
    let routingLogs = [];

    // Get state name from code
    function getStateName(code) {
      const state = US_STATES.find(s => s.code === code);
      return state ? state.name : code;
    }

    // Format date
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;

      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Load providers
    async function loadProviders() {
      const { data, error } = await supabase.from('providers').select('*');
      if (error) {
        console.error(error);
        return;
      }
      providers = data || [];
    }

    // Load credentials with provider status and effective_date
    async function loadCredentials() {
      const { data, error } = await supabase
        .from('provider_credentials')
        .select('state, payer, status, effective_date, provider_id, providers(status)');
      if (error) {
        console.error(error);
        return;
      }
      credentials = data || [];
    }

    // Load routing logs
    async function loadRoutingLogs() {
      const { data, error } = await supabase
        .from('routing_log')
        .select('*, providers(first_name, last_name)')
        .order('created_at', { ascending: false })
        .limit(50);
      if (error) {
        console.error(error);
        return;
      }
      routingLogs = data || [];
    }

    // Calculate stats using provider_credentials
    function calculateStats() {
      const activeProviders = providers.filter(p => p.status === 'Active');

      // Unique states covered: Active provider with Approved credential
      const coveredStates = new Set();
      credentials.forEach(c => {
        if (c.status === 'Approved' && c.providers && c.providers.status === 'Active') {
          coveredStates.add(c.state);
        }
      });

      // Unique payers covered: Active provider with Approved credential
      const coveredPayers = new Set();
      credentials.forEach(c => {
        if (c.status === 'Approved' && c.providers && c.providers.status === 'Active') {
          coveredPayers.add(c.payer);
        }
      });

      document.getElementById('statActiveProviders').textContent = activeProviders.length;
      document.getElementById('statStatesCovered').textContent = coveredStates.size;
      document.getElementById('statPayersCovered').textContent = coveredPayers.size;

      return { activeProviders, coveredStates, coveredPayers };
    }

    // Build coverage matrix using provider_credentials
    // V2.2: 4-color matrix: Green (routable), Blue (approved-pending), Amber (in progress), Red (gap)
    // Blocked providers are NOT counted in green cells - they can't be billed through
    function buildCoverageMatrix(priorityOnly = false) {
      const today = new Date().toISOString().split('T')[0];

      // Count blocked providers with approved credentials (for footnote)
      const blockedWithCreds = new Set();
      credentials.forEach(c => {
        if (c.status === 'Approved' && c.effective_date && c.effective_date <= today &&
            c.providers && c.providers.status === 'Blocked') {
          blockedWithCreds.add(c.provider_id);
        }
      });
      const blockedCount = blockedWithCreds.size;

      // Determine which states to show
      let statesToShow;
      if (priorityOnly) {
        statesToShow = [...PRIORITY_STATES].sort();
      } else {
        // Show all 50 states + DC, sorted alphabetically by state code
        statesToShow = US_STATES.map(s => s.code).sort();
      }

      // Build coverage data from credentials
      const coverageData = {};
      let totalGaps = 0;

      statesToShow.forEach(state => {
        coverageData[state] = {};
        CANONICAL_PAYERS.forEach(payer => {
          // ROUTABLE NOW: Active provider + Approved + effective_date <= today
          // NOTE: Blocked providers are explicitly excluded - they can't be billed through
          const routableSet = new Set();
          credentials.forEach(c => {
            if (c.state === state && c.payer === payer && c.status === 'Approved' &&
                c.effective_date && c.effective_date <= today &&
                c.providers && c.providers.status === 'Active') {
              routableSet.add(c.provider_id);
            }
          });
          const routableCount = routableSet.size;

          // APPROVED-PENDING: Approved but effective_date > today (Active provider only)
          const approvedPendingSet = new Set();
          credentials.forEach(c => {
            if (c.state === state && c.payer === payer && c.status === 'Approved' &&
                c.effective_date && c.effective_date > today &&
                c.providers && c.providers.status === 'Active') {
              approvedPendingSet.add(c.provider_id);
            }
          });
          const approvedPendingCount = approvedPendingSet.size;

          // IN PROGRESS: status = 'In Progress' (any provider status except Blocked)
          const inProgressSet = new Set();
          credentials.forEach(c => {
            if (c.state === state && c.payer === payer && c.status === 'In Progress' &&
                c.providers && c.providers.status !== 'Blocked') {
              inProgressSet.add(c.provider_id);
            }
          });
          const inProgressCount = inProgressSet.size;

          coverageData[state][payer] = {
            routable: routableCount,
            approvedPending: approvedPendingCount,
            inProgress: inProgressCount
          };

          if (routableCount === 0 && approvedPendingCount === 0 && inProgressCount === 0) {
            totalGaps++;
          }
        });
      });

      document.getElementById('statGaps').textContent = totalGaps;

      // Render matrix
      const table = document.getElementById('coverageMatrix');
      const thead = table.querySelector('thead tr');
      const tbody = table.querySelector('tbody');

      // Header row
      thead.innerHTML = '<th class="text-left py-2 px-3 text-sm font-medium text-gray-500 bg-gray-50 sticky left-0">State</th>';
      CANONICAL_PAYERS.forEach(payer => {
        thead.innerHTML += `<th class="text-center py-2 px-3 text-sm font-medium text-gray-500 bg-gray-50">${payer}</th>`;
      });

      // Data rows
      tbody.innerHTML = statesToShow.map(state => {
        let row = `<tr><td class="py-2 px-3 text-sm font-medium text-gray-900 bg-white sticky left-0">${state}</td>`;
        CANONICAL_PAYERS.forEach(payer => {
          const data = coverageData[state][payer];
          let cellClass, cellContent;

          if (data.routable > 0) {
            // Green: Routable now
            cellClass = 'coverage-covered';
            cellContent = data.routable;
          } else if (data.approvedPending > 0) {
            // Blue: Approved but not yet effective
            cellClass = 'coverage-pending';
            cellContent = data.approvedPending;
          } else if (data.inProgress > 0) {
            // Amber: In progress
            cellClass = 'coverage-pipeline';
            cellContent = `(${data.inProgress})`;
          } else {
            // Red: Gap
            cellClass = 'coverage-gap';
            cellContent = '0';
          }

          row += `<td class="coverage-cell ${cellClass}">${cellContent}</td>`;
        });
        row += '</tr>';
        return row;
      }).join('');

      // Add footnote for blocked providers with credentials
      const footnoteContainer = document.getElementById('blockedFootnote');
      if (blockedCount > 0) {
        if (!footnoteContainer) {
          const matrixContainer = table.parentElement;
          const footnote = document.createElement('div');
          footnote.id = 'blockedFootnote';
          footnote.className = 'mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg flex items-start gap-2';
          footnote.innerHTML = `
            <i data-feather="alert-triangle" class="h-5 w-5 text-amber-600 flex-shrink-0"></i>
            <p class="text-sm text-amber-800">
              <strong>${blockedCount} provider${blockedCount !== 1 ? 's have' : ' has'} approved credentials but ${blockedCount !== 1 ? 'are' : 'is'} blocked</strong>
              (not counted in green cells). Resolving blocks could increase coverage.
            </p>
          `;
          matrixContainer.appendChild(footnote);
          feather.replace({ width: 20, height: 20 });
        } else {
          footnoteContainer.querySelector('p').innerHTML = `
            <strong>${blockedCount} provider${blockedCount !== 1 ? 's have' : ' has'} approved credentials but ${blockedCount !== 1 ? 'are' : 'is'} blocked</strong>
            (not counted in green cells). Resolving blocks could increase coverage.
          `;
        }
      } else if (footnoteContainer) {
        footnoteContainer.remove();
      }
    }

    // Render recent activity
    function renderRecentActivity() {
      const tbody = document.getElementById('routingActivity');

      if (routingLogs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No routing activity yet</td></tr>';
        return;
      }

      tbody.innerHTML = routingLogs.map(log => {
        const providerName = log.providers
          ? `${log.providers.first_name} ${log.providers.last_name}`
          : '—';

        return `
          <tr class="border-b border-gray-100">
            <td class="py-2 text-gray-500">${formatDate(log.created_at)}</td>
            <td class="py-2">${log.patient_state}</td>
            <td class="py-2">${log.patient_payer === '*' ? 'All' : log.patient_payer}</td>
            <td class="py-2">
              ${log.matched
                ? '<span class="badge badge-active">Yes</span>'
                : '<span class="badge badge-blocked">No</span>'}
            </td>
            <td class="py-2 text-gray-500 truncate max-w-[150px]" title="${log.created_by || ''}">${log.created_by || '—'}</td>
          </tr>
        `;
      }).join('');
    }

    // Render top unmatched searches
    function renderUnmatchedSearches() {
      const unmatchedLogs = routingLogs.filter(l => !l.matched);

      // Group by state + payer
      const grouped = {};
      unmatchedLogs.forEach(log => {
        const key = `${log.patient_state}|${log.patient_payer}`;
        if (!grouped[key]) {
          grouped[key] = { state: log.patient_state, payer: log.patient_payer, count: 0 };
        }
        grouped[key].count++;
      });

      // Sort by count and take top 10
      const sorted = Object.values(grouped)
        .sort((a, b) => b.count - a.count)
        .slice(0, 10);

      const container = document.getElementById('unmatchedSearches');

      if (sorted.length === 0) {
        container.innerHTML = '<p class="text-center py-8 text-gray-500">No unmatched searches recorded</p>';
        return;
      }

      container.innerHTML = sorted.map((item, index) => {
        const payerDisplay = item.payer === '*' ? 'All Payers' : item.payer;
        const barWidth = (item.count / sorted[0].count) * 100;

        return `
          <div class="flex items-center gap-3">
            <span class="text-sm text-gray-500 w-6">${index + 1}.</span>
            <div class="flex-1">
              <div class="flex items-center justify-between mb-1">
                <span class="text-sm font-medium text-gray-900">${getStateName(item.state)} + ${payerDisplay}</span>
                <span class="text-sm text-red-600 font-medium">${item.count} failed</span>
              </div>
              <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                <div class="h-full bg-red-400 rounded-full" style="width: ${barWidth}%"></div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Initialize
    async function init() {
      try {
        currentUser = await requireAuth();
        supabase = await getSupabase();

        document.getElementById('userEmail').textContent = currentUser.email;
        wireLogoutButton();

        // Load data
        await Promise.all([loadProviders(), loadCredentials(), loadRoutingLogs()]);

        // Render
        calculateStats();
        buildCoverageMatrix(false);
        renderRecentActivity();
        renderUnmatchedSearches();

        // Priority states toggle
        document.getElementById('priorityStatesToggle').addEventListener('change', (e) => {
          buildCoverageMatrix(e.target.checked);
        });

        feather.replace();
      } catch (e) {
        console.error('Init error:', e);
      }
    }

    init();
  </script>
</body>
</html>
